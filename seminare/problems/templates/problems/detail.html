{% extends "base.html" %}
{% load markdownify %}
{% load ui %}

{% block title %}{{ problem.name }} {{ block.super }}{% endblock %}

{% block body_container %}
<div class="border-b px-4 py-3">
  {% url "problem_set_list" as set_list_url %}
  {% url "problem_set_detail" problem.problem_set.slug as set_url %}
  {% breadcrumbs "Zadania" set_list_url problem.problem_set set_url problem %}
</div>

<div data-controller="submit--cta">
  <div class="flex flex-col lg:flex-row" data-controller="toggle" data-toggle-toggle-class="hidden">
    {% include "problems/_sidebar.html" with problem_set=problem.problem_set %}

    <div class="flex-1 p-4 lg:py-8">
      <div class="mx-auto max-w-prose">
        <a href="#" class="mb-2 flex justify-end items-center text-blue-700 hover:text-blue-900 lg:hidden"
            data-action="click->toggle#click">
          Zoznam úloh
          <iconify-icon icon="mdi:chevron-down" class="ml-1"></iconify-icon>
        </a>

        {% if texts.PS.is_visible or is_organizer %}
          {% if is_organizer %}
            {% message "Túto sekciu vidíš, lebo si organizátor" "warning" %}
          {% endif %}
        <div class="prose">
          {{ texts.PS.text|markdownify }}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="shrink-0 w-full p-4 md:border-l md:w-80">
      {% if not user.is_authenticated %}
        <div class="flex items-center text-red-600 bg-red-100 rounded-md py-2 px-3 mb-4 text-sm">
          <iconify-icon icon="mdi:warning" width="none" class="shrink-0 mr-3 size-4"></iconify-icon>
          <span>
            Pre odovzdávanie sa musíš <a href="{% url "oidc_authentication_init" %}?next={{ request.path_info|urlencode }}" class="underline hover:text-red-700">prihlásiť</a>.
          </span>
        </div>
      {% else %}
        <div data-submit--cta-target="submitForm" id="submit">
          {% for id, data in submits.items %}
            <div data-controller="submit--{{ id }}-submit">
              <div class="font-bold text-2xl mb-1 flex justify-between">
                <span>Odovzdať {{ data.name }}</span>
                {# TODO: actual max points and maybe also current points #}
                <div class="flex items-center">{% label data.points %}</div>
              </div>

              {% if data.can_submit %}
                {% if id != "text" %}
                  <div class="bg-gray-100 rounded-md text-gray-700 text-center p-4 cursor-pointer hover:bg-gray-200" data-action="click->submit--{{ id }}-submit#openFilePicker">
                    <iconify-icon icon="mdi:upload" width="none" class="size-8"></iconify-icon>
                    <p data-submit--{{ id }}-submit-target="fileText">Vyber alebo presuň tvoj program sem</p>
                  </div>
                {% endif %}

                <div class="hidden items-center text-amber-600 bg-amber-100 rounded-md py-2 px-3 my-4 text-sm" data-submit--{{ id }}-submit-target="errorContainer">
                  <iconify-icon icon="mdi:warning" width="none" class="shrink-0 mr-3 size-4"></iconify-icon>
                  <span data-submit--{{ id }}-submit-target="errorMessage"></span>
                </div>

                <form method="POST" enctype="multipart/form-data" action="{{ data.action }}" id="form" class="{% if id != "text" %}hidden{% else %}flex flex-row gap-2{% endif %} mt-2" data-submit--{{ id }}-submit-target="form">
                  {% csrf_token %}
                  {% if id == "file" %}
                    <input type="file" name="files" multiple accept="image/jpeg, image/png, application/pdf" class="hidden" data-submit--file-submit-target="fileInput" data-action="change->submit--file-submit#onInputChange">
                    <button class="btn btn-blue mt-2">Odovzdať</button>
                  {% elif id == "judge" %}
                    <input type="file" name="program" class="hidden" data-submit--judge-submit-target="fileInput" data-action="change->submit--judge-submit#onInputChange">
                    <button class="btn btn-blue mt-2">Odovzdať</button>
                  {% else %}
                    <input type="text" name="text" class="input">
                    <button class="btn btn-blue" title="Odovzdať"><iconify-icon icon="mdi:send" width="none" class="size-5"></iconify-icon></button>
                  {% endif %}
                </form>
              {% else %}
                {% message data.name|title|stringformat:"s momentálne nemôžeš odovzdať" "warning" %}
              {% endif %}

              {% include "problems/_submits.html" with submits=data %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="fixed inset-x bottom-0 z-30 w-full p-4 flex items-center md:hidden" data-submit--cta-target="cta">
    <button type="button" data-action="submit--cta#scroll" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-800 text-white mx-auto w-auto shadow-lg" id="scroll">
      Odovzdávanie
      <iconify-icon icon="mdi:arrow-down"></iconify-icon>
    </button>
  </div>
</div>
{% endblock %}
